const oracledb = require('oracledb');
require('dotenv').config();

async function setupDatabase() {
  console.log('============================================');
  console.log('   SETUP BASE DE DATOS CROWDFUNDING');
  console.log('   Oracle 21c XE - PDB: XEPDB1');
  console.log('============================================\n');
  
  let connection;
  
  try {
    // 1. Conectar
    console.log('üîó Conectando a la base de datos...');
    console.log(`   Usuario: ${process.env.DB_USER}`);
    console.log(`   PDB: ${process.env.DB_CONNECT_STRING.split(':')[2]}`);
    
    connection = await oracledb.getConnection({
      user: process.env.DB_USER,
      password: process.env.DB_PASSWORD,
      connectString: process.env.DB_CONNECT_STRING
    });
    
    console.log('‚úÖ Conexi√≥n establecida\n');
    
    // 2. Crear tablas
    console.log('üìä Creando tablas del sistema...\n');
    
    const tablas = [
      {
        nombre: 'usuarios',
        sql: `CREATE TABLE usuarios (
          id_usuario NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
          nombre VARCHAR2(100) NOT NULL,
          email VARCHAR2(100) UNIQUE NOT NULL,
          password VARCHAR2(255) NOT NULL,
          tipo_usuario VARCHAR2(20) CHECK (tipo_usuario IN ('inversor', 'emprendedor', 'admin')),
          saldo NUMBER(10,2) DEFAULT 0,
          fecha_registro DATE DEFAULT SYSDATE
        )`,
        comentario: 'Tabla de usuarios del sistema'
      },
      {
        nombre: 'proyectos',
        sql: `CREATE TABLE proyectos (
          id_proyecto NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
          id_emprendedor NUMBER REFERENCES usuarios(id_usuario),
          titulo VARCHAR2(200) NOT NULL,
          descripcion CLOB,
          categoria VARCHAR2(50),
          meta_financiera NUMBER(10,2) NOT NULL,
          fondos_recaudados NUMBER(10,2) DEFAULT 0,
          fecha_creacion DATE DEFAULT SYSDATE,
          fecha_limite DATE NOT NULL,
          estado VARCHAR2(20) DEFAULT 'activo' CHECK (estado IN ('activo', 'completado', 'cancelado', 'expirado'))
        )`,
        comentario: 'Tabla de proyectos de crowdfunding'
      },
      {
        nombre: 'inversiones',
        sql: `CREATE TABLE inversiones (
          id_inversion NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
          id_inversor NUMBER REFERENCES usuarios(id_usuario),
          id_proyecto NUMBER REFERENCES proyectos(id_proyecto),
          monto NUMBER(10,2) NOT NULL,
          fecha_inversion DATE DEFAULT SYSDATE,
          recompensa VARCHAR2(200),
          estado VARCHAR2(20) DEFAULT 'pendiente' CHECK (estado IN ('pendiente', 'confirmada', 'reembolsada'))
        )`,
        comentario: 'Tabla de inversiones realizadas'
      },
      {
        nombre: 'actualizaciones',
        sql: `CREATE TABLE actualizaciones (
          id_actualizacion NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
          id_proyecto NUMBER REFERENCES proyectos(id_proyecto),
          titulo VARCHAR2(200),
          contenido CLOB,
          fecha_publicacion DATE DEFAULT SYSDATE
        )`,
        comentario: 'Actualizaciones de los proyectos'
      },
      {
        nombre: 'comentarios',
        sql: `CREATE TABLE comentarios (
          id_comentario NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
          id_proyecto NUMBER REFERENCES proyectos(id_proyecto),
          id_usuario NUMBER REFERENCES usuarios(id_usuario),
          comentario CLOB,
          fecha_comentario DATE DEFAULT SYSDATE
        )`,
        comentario: 'Comentarios en proyectos'
      }
    ];
    
    // Crear cada tabla
    for (const tabla of tablas) {
      try {
        // Intentar eliminar si existe
        await connection.execute(`DROP TABLE ${tabla.nombre} CASCADE CONSTRAINTS`);
        console.log(`   üóëÔ∏è  Eliminada tabla anterior: ${tabla.nombre}`);
      } catch (dropErr) {
        // Si no existe, continuar
        if (dropErr.errorNum !== 942) { // ORA-00942: table does not exist
          console.log(`   ‚ö†Ô∏è  Nota: ${dropErr.message.split('\n')[0]}`);
        }
      }
      
      // Crear tabla
      await connection.execute(tabla.sql);
      console.log(`   ‚úÖ Creada: ${tabla.nombre} - ${tabla.comentario}`);
    }
    
    await connection.commit();
    console.log('\n‚úÖ Todas las tablas creadas\n');
    
    // 3. Insertar datos de prueba
    console.log('üë• Insertando datos de prueba...\n');
    
    const bcrypt = require('bcryptjs');
    
    // Insertar emprendedor
    const hashEmprendedor = await bcrypt.hash('emprendedor123', 10);
    await connection.execute(
      `INSERT INTO usuarios (nombre, email, password, tipo_usuario) 
       VALUES (:1, :2, :3, :4)`,
      ['Juan Emprendedor', 'emprendedor@crowdboost.com', hashEmprendedor, 'emprendedor'],
      { autoCommit: true }
    );
    console.log('   üë§ Usuario emprendedor creado');
    
    // Insertar inversor
    const hashInversor = await bcrypt.hash('inversor123', 10);
    await connection.execute(
      `INSERT INTO usuarios (nombre, email, password, tipo_usuario, saldo) 
       VALUES (:1, :2, :3, :4, :5)`,
      ['Ana Inversora', 'inversor@crowdboost.com', hashInversor, 'inversor', 5000],
      { autoCommit: true }
    );
    console.log('   üë§ Usuario inversor creado');
    
    // Insertar proyectos de ejemplo
    const proyectos = [
      ['App de Reciclaje Inteligente', 'Aplicaci√≥n que incentiva el reciclaje con recompensas', 'tecnologia', 5000, 30],
      ['Huertos Urbanos Comunitarios', 'Creaci√≥n de huertos en espacios urbanos', 'ecologia', 3000, 45],
      ['Plataforma Educativa Online', 'Cursos interactivos para ni√±os', 'educacion', 7500, 60]
    ];
    
    for (const [titulo, desc, categoria, meta, dias] of proyectos) {
      await connection.execute(
        `INSERT INTO proyectos (id_emprendedor, titulo, descripcion, categoria, meta_financiera, fecha_limite) 
         VALUES (1, :1, :2, :3, :4, SYSDATE + :5)`,
        [titulo, desc, categoria, meta, dias],
        { autoCommit: true }
      );
      console.log(`   üöÄ Proyecto: ${titulo}`);
    }
    
    // Insertar inversiones de ejemplo
    await connection.execute(
      `INSERT INTO inversiones (id_inversor, id_proyecto, monto) 
       VALUES (2, 1, 500)`,
      [],
      { autoCommit: true }
    );
    
    await connection.execute(
      `INSERT INTO inversiones (id_inversor, id_proyecto, monto) 
       VALUES (2, 2, 750)`,
      [],
      { autoCommit: true }
    );
    
    console.log('   üí∞ Inversiones de ejemplo creadas');
    
    // 4. Verificar datos
    console.log('\nüìã Verificando datos insertados...\n');
    
    const conteo = await connection.execute(`
      SELECT 
        (SELECT COUNT(*) FROM usuarios) as usuarios,
        (SELECT COUNT(*) FROM proyectos) as proyectos,
        (SELECT COUNT(*) FROM inversiones) as inversiones
      FROM dual
    `);
    
    console.log('üìä RESUMEN DE DATOS:');
    console.log(`   Usuarios: ${conteo.rows[0][0]}`);
    console.log(`   Proyectos: ${conteo.rows[0][1]}`);
    console.log(`   Inversiones: ${conteo.rows[0][2]}`);
    
    await connection.close();
    
    console.log('\n============================================');
    console.log('   ‚úÖ SETUP COMPLETADO EXITOSAMENTE');
    console.log('============================================');
    
    console.log('\nüéâ ¬°Base de datos lista para usar!');
    console.log('\nüë§ CREDENCIALES DE PRUEBA:');
    console.log('   Emprendedor: emprendedor@crowdboost.com / emprendedor123');
    console.log('   Inversor: inversor@crowdboost.com / inversor123');
    console.log('\nüöÄ PR√ìXIMOS PASOS:');
    console.log('1. Iniciar servidor: npm run dev');
    console.log('2. Probar API: http://localhost:3000/api/proyectos');
    console.log('3. Abrir frontend en navegador');
    
  } catch (err) {
    console.error('\n‚ùå ERROR:', err.message);
    
    if (err.message.includes('ORA-01017')) {
      console.log('\nüîß Usuario/contrase√±a incorrectos');
      console.log('   Verifica que el usuario crowdfunding_app exista en XEPDB1');
    } else if (err.message.includes('ORA-12514')) {
      console.log('\nüîß Servicio XEPDB1 no encontrado');
      console.log('   Verifica que el PDB XEPDB1 est√© abierto');
      console.log('   En SQL Developer (como SYSTEM a XE):');
      console.log('   ALTER PLUGGABLE DATABASE XEPDB1 OPEN;');
    }
  }
}

setupDatabase();